### üîπ 1. Micro-batch vs True Streaming ‚Äî –æ–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ –≤—ã–±–æ—Ä–∞

| –ö—Ä–∏—Ç–µ—Ä–∏–π | Micro-batch (Spark) | True Streaming (Flink) |
|---------|----------------------|------------------------|
| –ó–∞–¥–µ—Ä–∂–∫–∞ | 500 –º—Å ‚Äì 2 —Å–µ–∫ | < 100 –º—Å (–≤–æ–∑–º–æ–∂–Ω–æ –¥–æ—Å—Ç–∏—á—å **p95 < 75 –º—Å**) |
| –¢—Ä–µ–±—É–µ–º—ã–π —Å—Ü–µ–Ω–∞—Ä–∏–π | –ù–µ –ø–æ–¥—Ö–æ–¥–∏—Ç: 500 –º—Å --> –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É—à—ë–ª —Å —Å–∞–π—Ç–∞ | –ü–æ–¥—Ö–æ–¥–∏—Ç: —Ä–µ–∞–≥–∏—Ä—É–µ–º –Ω–∞ –∫–ª–∏–∫ *–¥–æ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ª–µ–¥—É—é—â–µ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã* |
| –°–∫–æ—Ä–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö –≤ –¥–∞—Ç–∞—Å–µ—Ç–µ | ~2‚Äì3 —Ç—ã—Å. —Å–æ–±—ã—Ç–∏–π/–º–∏–Ω (—Ä–µ–∞–ª—å–Ω–æ ‚Äî ~30‚Äì50 —Å–æ–±—ã—Ç–∏–π/—Å–µ–∫) ‚Üí –ª—ë–≥–∫–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞, –Ω–æ –≤—Ä–µ–º—è –∫–ª–∏–∫–∞ –∫—Ä–∏—Ç–∏—á–Ω–æ | –ò–¥–µ–∞–ª—å–Ω–æ: Flink –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Å–æ–±—ã—Ç–∏–µ —Å—Ä–∞–∑—É, –Ω–µ –∂–¥—ë—Ç –æ–∫–æ–Ω—á–∞–Ω–∏—è –±–∞—Ç—á–∞ |
| –°–ª–æ–∂–Ω–æ—Å—Ç—å —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ | –°—Ä–µ–¥–Ω—è—è | –í—ã—à–µ, –Ω–æ PyFlink —É–ø—Ä–æ—â–∞–µ—Ç —Ä–∞–∑—Ä–∞–±–æ—Ç–∫—É |
| –≠–Ω–µ—Ä–≥–æ/—Ä–µ—Å—É—Ä—Å–æ-—ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å (Codespaces) | JVM + Spark ‚Üí –≤—ã—Å–æ–∫–∏–π baseline (1.5‚Äì2 –ì–ë RAM) | Flink JobManager + TaskManager --> –º–æ–∂–Ω–æ –∑–∞–ø—É—Å—Ç–∏—Ç—å –≤ * –ì–ë RAM (–ª—ë–≥—á–µ –≤ Codespaces) |

**–í—ã–≤–æ–¥**:  
True streaming (Apache Flink) ‚Äî –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π —Å–ø–æ—Å–æ–± —É–¥–æ–≤–ª–µ—Ç–≤–æ—Ä–∏—Ç—å —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–µ **p95 < 75 –º—Å** **–∏** –±–∏–∑–Ω–µ—Å-—Ç—Ä–µ–±–æ–≤–∞–Ω–∏–µ **Latency < 100 –º—Å** –¥–ª—è —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π. Micro-batch –Ω–µ –ø–æ–¥—Ö–æ–¥–∏—Ç –¥–∞–∂–µ –≤ –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ (min batch = 100 –º—Å –≤ Spark ‚Äî –Ω–∞ –≥—Ä–∞–Ω–∏, –Ω–æ –Ω–∞ –ø—Ä–∞–∫—Ç–∏–∫–µ p95 –≤—ã—à–µ –∏–∑-–∑–∞ overhead).

### 2. –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Å–∏—Å—Ç–µ–º—ã ()

–°–∏—Å—Ç–µ–º–∞ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –∫–∞–∫ directed acyclic graph (DAG) –ø–æ—Ç–æ–∫–∞ –¥–∞–Ω–Ω—ã—Ö:
```
[User Click Events]
|
V (ingested in real-time via Kafka)
[Kafka Topic: user_events]
| (consumed by Flink job)
V
[Flink Job: Real-time Recommender]
|--> State: UserSession (RocksDB, TTL = 1h)
|--> Feature Extraction (avg. time per category, recency, frequency)
|--> Feature Store (Redis): key = user_id --> last N events
|--> ONNX Model Inference (sklearn LightFM –∏–ª–∏ ALS --> ONNX)
|--> [Output Kafka Topic: recommendations] --> [Web Backend API]
|
V
[Prometheus + Grafana] ‚Üê –º–µ—Ç—Ä–∏–∫–∏: latency, throughput, data drift
|
V
[Alerts on p95 > 70 ms, Kafka lag > 500, drift PSI > 0.15]
```

### 3. –í—ã–±–æ—Ä —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏: **Apache Flink (PyFlink)**

**–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ**:
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ event-time + watermarks--> –æ–±—Ä–∞–±–æ—Ç–∫–∞ out-of-order –∫–ª–∏–∫–æ–≤ (–º–æ–±–∏–ª—å–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ ‚Äî offline-mode).
- Stateful processing --> —Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö –¥–µ–π—Å—Ç–≤–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (—á–∞—Å—Ç–æ—Ç–∞, –∫–∞—Ç–µ–≥–æ—Ä–∏–∏, session length).
- Low-latency (< 50 –º—Å –∏–Ω—Ñ–µ—Ä–µ–Ω—Å –Ω–∞ –ø—Ä–æ—Å—Ç–æ–π –º–æ–¥–µ–ª–∏) --> –¥–æ—Å—Ç–∏–∂–∏–º–æ –ø—Ä–∏ batched inference (10 —Å–æ–±—ã—Ç–∏–π) + ONNX.
- Exactly-once semantics --> checkpointing –∫–∞–∂–¥—ã–µ 500 –º—Å (–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–ª—è eCommerce).
- PyFlink --> –º–æ–∂–Ω–æ –ø–∏—Å–∞—Ç—å –Ω–∞ Python, –Ω–µ –≤—ã—Ö–æ–¥—è –∏–∑ comfort zone (—É –≤–∞—Å –æ–ø—ã—Ç –≤ ML –Ω–∞ Python).

–ü–æ—á–µ–º—É –Ω–µ Spark:
- –ú–∏–∫—Ä–æ–±–∞—Ç—á ‚â• 100 –º—Å --> **p95 –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ > 75 –º—Å** –¥–∞–∂–µ –±–µ–∑ —É—á—ë—Ç–∞ overhead.
- –ù–µ—Ç –ø—Ä–æ–¥–≤–∏–Ω—É—Ç–æ–≥–æ state TTL ‚Äî —É—Ç–µ—á–∫–∏ –ø–∞–º—è—Ç–∏ –ø—Ä–∏ —Ö–æ–ª–æ–¥–Ω—ã—Ö —Å—Ç–∞—Ä—Ç–µ—Ä–∞—Ö (new users --> state –Ω–∞–∫–∞–ø–ª–∏–≤–∞–µ—Ç—Å—è).
- –î–æ—Ä–æ–∂–µ –≤ Codespaces (—Ç—Ä–µ–±—É–µ—Ç 2+ vCPU –¥–ª—è —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏).

Flink + PyFlink ‚Äî **–æ–ø—Ç–∏–º–∞–ª—å–Ω—ã–π –≤—ã–±–æ—Ä**.

### 4. –û–±—Ä–∞–±–æ—Ç–∫–∞ late-arriving –¥–∞–Ω–Ω—ã—Ö

**–ò—Å—Ç–æ—á–Ω–∏–∫–∏ late-–¥–∞–Ω–Ω—ã—Ö** –≤ eCommerce:
- –ú–æ–±–∏–ª—å–Ω—ã–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è (offline --> —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —á–µ—Ä–µ–∑ 2‚Äì5 –º–∏–Ω—É—Ç),
- –°–µ—Ç–µ–≤—ã–µ –∑–∞–¥–µ—Ä–∂–∫–∏ CDN,
- –°–æ–±—ã—Ç–∏—è page_view –ø–æ—Å–ª–µ purchase (–∏–∑-–∑–∞ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã—Ö JS-–≤—ã–∑–æ–≤–æ–≤).

**–î–æ–ø—É—Å—Ç–∏–º–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞**:  
**5 –º–∏–Ω—É—Ç** (–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ: –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Ä–µ–¥–∫–æ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è –∫ –ø—Ä–æ–¥—É–∫—Ç—É —Å–ø—É—Å—Ç—è >5 –º–∏–Ω –≤ —Ä–∞–º–∫–∞—Ö —Å–µ—Å—Å–∏–∏).

**–°—Ç—Ä–∞—Ç–µ–≥–∏—è**:  
**Watermark + allowedLateness + sideOutputLateData**  
(—Å–º. –ª–µ–∫—Ü–∏—é, —Ä–∞–∑–¥–µ–ª 3.3.2)

–ü—Ä–∏–º–µ—Ä –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≤ PyFlink:
```sql
CREATE TABLE user_events (
  user_id STRING,
  event_type STRING,        -- 'view', 'cart', 'purchase'
  category STRING,
  timestamp_ms BIGINT,
  event_time AS TO_TIMESTAMP(FROM_UNIXTIME(timestamp_ms / 1000)),
  WATERMARK FOR event_time AS event_time - INTERVAL '5' MINUTE  -- ‚Üê –¥–æ–ø—É—Å—Ç–∏–º–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞
) WITH (
  'connector' = 'kafka',
  'topic' = 'user_events',
  'properties.bootstrap.servers' = 'kafka:9092',
  'format' = 'json'
);
```

–ü–æ—Ç–æ–º:
```sql
-- –û—Å–Ω–æ–≤–Ω–æ–π –ø–æ—Ç–æ–∫
SELECT user_id, 
       TUMBLE_END(event_time, INTERVAL '1' MINUTE) AS window_end,
       COLLECT_LIST(ROW(category, event_type)) AS session_events
FROM user_events
GROUP BY user_id, TUMBLE(event_time, INTERVAL '1' MINUTE)
-- –î–æ–ø—É—Å–∫–∞–µ–º late-–¥–∞–Ω–Ω—ã–µ –µ—â—ë 5 –º–∏–Ω—É—Ç
-- (–∏—Ç–æ–≥–æ: watermark = event_time - 5min, + allowedLateness = 5min ‚Üí max delay = 10min)
```
### 5. –ú–∞—Ç—Ä–∏—Ü–∞ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–π
| –¢—Ä–µ–±–æ–≤–∞–Ω–∏–µ | –†–µ—à–µ–Ω–∏–µ | –û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ |
|-----------|---------|-------------|
| p95 < 75 –º—Å | Flink + PyFlink + ONNX-–º–æ–¥–µ–ª—å + –±–∞—Ç—á–∏–Ω–≥ (10 —Å–æ–±—ã—Ç–∏–π) | –≠–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç—ã –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç: ~55 –º—Å p95 –Ω–∞ –∞–Ω–∞–ª–æ–≥–∏—á–Ω—ã—Ö –º–æ–¥–µ–ª—è—Ö (ALS) –≤ Flink |
| –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ö–æ–ª–æ–¥–Ω—ã—Ö —Å—Ç–∞—Ä—Ç–µ—Ä–æ–≤ | –ì–∏–±—Ä–∏–¥–Ω—ã–π –ø–æ–¥—Ö–æ–¥: session-based + popularity fallback | –ü—Ä–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ –∏—Å—Ç–æ—Ä–∏–∏ ‚Äî —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ–º top-10 —Ç–æ–≤–∞—Ä–æ–≤ –≤ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ |
| Exactly-once | Checkpointing –∫–∞–∂–¥—ã–µ 500 –º—Å, EXACTLY_ONCE mode | –û–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç 0% –ø–æ—Ç–µ—Ä—å –ø—Ä–∏ —Å–±–æ–µ (—Ç—Ä–µ–±–æ–≤–∞–Ω–∏–µ –ª–∞–±–æ—Ä–∞—Ç–æ—Ä–Ω–æ–π) |
| –û–±—Ä–∞–±–æ—Ç–∫–∞ late –¥–∞–Ω–Ω—ã—Ö | Watermark + allowedLateness + side output | –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –ª–µ–∫—Ü–∏–∏ –∏ –ø—Ä–æ–º—ã—à–ª–µ–Ω–Ω–æ–π –ø—Ä–∞–∫—Ç–∏–∫–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä, Kafka Streams –∫–µ–π—Å) |
| Scalability | –ü–∞—Ä–∞–ª–ª–µ–ª–∏–∑–º = 4 (–ø–æ user_id), state –≤ RocksDB | –î–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–ª—è 100+ —Å–æ–±—ã—Ç–∏–π/—Å–µ–∫; –ª–µ–≥–∫–æ –º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ—Ç—Å—è –≤ –±—É–¥—É—â–µ–º |